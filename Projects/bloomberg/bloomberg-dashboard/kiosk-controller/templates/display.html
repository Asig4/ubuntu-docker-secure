<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bloomberg Kiosk — Display</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100vw; height: 100vh; overflow: hidden; background: #0a0a0a; }
#grafana-frame {
    width: 100vw;
    height: 100vh;
    border: none;
}
#status {
    position: fixed;
    bottom: 12px;
    right: 12px;
    padding: 6px 14px;
    border-radius: 6px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    color: #a0a0a0;
    background: rgba(10,10,10,0.85);
    border: 1px solid #1a1a2e;
    transition: opacity 0.5s;
    opacity: 0;
    z-index: 1000;
    pointer-events: none;
}
#status.visible { opacity: 1; }
#status.connected { border-color: #00d4aa; }
#status.disconnected { border-color: #ff3b3b; color: #ff3b3b; }

/* PIP overlay */
#pip-container {
    position: fixed;
    z-index: 500;
    border: 2px solid #ff8c00;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 4px 24px rgba(0,0,0,0.6);
    display: none;
    transition: opacity 0.3s;
}
#pip-container.visible { display: block; }
#pip-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}
#pip-label {
    position: absolute;
    top: 6px;
    left: 8px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    color: #ff8c00;
    background: rgba(0,0,0,0.7);
    padding: 2px 6px;
    border-radius: 3px;
    pointer-events: none;
}
#pip-error {
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: #ff3b3b;
    background: rgba(0,0,0,0.85);
    text-align: center;
    padding: 12px;
}
#pip-error.visible { display: flex; }
</style>
</head>
<body>

<iframe id="grafana-frame" src="{{ grafana_url }}"></iframe>

<div id="pip-container">
    <video id="pip-video" autoplay muted playsinline></video>
    <div id="pip-label">WeChat</div>
    <div id="pip-error">Stream offline</div>
</div>

<div id="status">Connecting...</div>

<script>
(function() {
    const frame = document.getElementById('grafana-frame');
    const status = document.getElementById('status');
    const pipContainer = document.getElementById('pip-container');
    const pipVideo = document.getElementById('pip-video');
    const pipError = document.getElementById('pip-error');

    let ws = null;
    let reconnectDelay = 2000;
    const MAX_DELAY = 30000;
    let hideTimer = null;
    let pingInterval = null;
    let hls = null;
    let currentPipUrl = '';

    function showStatus(text, cls) {
        status.textContent = text;
        status.className = 'visible ' + (cls || '');
        clearTimeout(hideTimer);
        hideTimer = setTimeout(() => { status.className = cls || ''; }, 3000);
    }

    // --- PIP positioning ---
    function applyPipLayout(pip) {
        if (!pip) return;

        const size = (pip.size || 25);
        const w = Math.round(window.innerWidth * size / 100);
        const h = Math.round(w * 9 / 16); // 16:9 aspect ratio
        const margin = 20;

        pipContainer.style.width = w + 'px';
        pipContainer.style.height = h + 'px';
        pipContainer.style.opacity = (pip.opacity || 100) / 100;

        const pos = pip.position || 'bottom-right';
        pipContainer.style.top = pos.startsWith('top') ? margin + 'px' : 'auto';
        pipContainer.style.bottom = pos.startsWith('bottom') ? margin + 'px' : 'auto';
        pipContainer.style.left = pos.endsWith('left') ? margin + 'px' : 'auto';
        pipContainer.style.right = pos.endsWith('right') ? margin + 'px' : 'auto';
    }

    // --- HLS stream ---
    function startStream(url) {
        if (!url || url === currentPipUrl) return;
        stopStream();
        currentPipUrl = url;
        pipError.classList.remove('visible');

        if (Hls.isSupported()) {
            hls = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                liveSyncDurationCount: 3,
                liveMaxLatencyDurationCount: 6,
            });
            hls.loadSource(url);
            hls.attachMedia(pipVideo);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                pipVideo.play().catch(() => {});
            });
            hls.on(Hls.Events.ERROR, function(event, data) {
                if (data.fatal) {
                    pipError.classList.add('visible');
                    if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                        setTimeout(() => {
                            pipError.classList.remove('visible');
                            hls.startLoad();
                        }, 5000);
                    }
                }
            });
        } else if (pipVideo.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari native HLS
            pipVideo.src = url;
            pipVideo.addEventListener('loadedmetadata', () => pipVideo.play().catch(() => {}));
        }
    }

    function stopStream() {
        if (hls) {
            hls.destroy();
            hls = null;
        }
        pipVideo.src = '';
        currentPipUrl = '';
    }

    // --- PIP state handler ---
    function handlePip(pip) {
        if (!pip) return;

        applyPipLayout(pip);

        if (pip.enabled && pip.url) {
            pipContainer.classList.add('visible');
            startStream(pip.url);
        } else {
            pipContainer.classList.remove('visible');
            stopStream();
        }
    }

    // --- WebSocket ---
    function connect() {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(proto + '//' + location.host + '/kiosk/ws');

        ws.onopen = function() {
            reconnectDelay = 2000;
            showStatus('Connected', 'connected');
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) ws.send('ping');
            }, 30000);
        };

        ws.onmessage = function(e) {
            try {
                const msg = JSON.parse(e.data);

                if (msg.type === 'init') {
                    const newUrl = msg.grafana_url;
                    if (frame.src !== newUrl) frame.src = newUrl;
                    handlePip(msg.pip);
                }

                if (msg.type === 'state_update' || msg.type === 'cycle_update') {
                    const newUrl = msg.grafana_url;
                    if (frame.src !== newUrl) {
                        frame.src = newUrl;
                        const asset = msg.state && msg.state.asset ? msg.state.asset : '';
                        showStatus(asset, 'connected');
                    }
                }

                if (msg.type === 'pip_update') {
                    handlePip(msg.pip);
                }
            } catch(err) {}
        };

        ws.onclose = function() {
            clearInterval(pingInterval);
            showStatus('Disconnected — reconnecting...', 'disconnected');
            setTimeout(() => {
                reconnectDelay = Math.min(reconnectDelay * 1.5, MAX_DELAY);
                connect();
            }, reconnectDelay);
        };

        ws.onerror = function() { ws.close(); };
    }

    // Resize PIP on window resize
    window.addEventListener('resize', function() {
        // Re-fetch state to re-apply layout
        fetch('/kiosk/api/state').then(r => r.json()).then(data => {
            if (data.pip) applyPipLayout(data.pip);
        }).catch(() => {});
    });

    connect();
})();
</script>
</body>
</html>
